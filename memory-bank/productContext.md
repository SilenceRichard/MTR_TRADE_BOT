# 项目上下文 (Product Context)

*此文件提供项目的综合概览，包括目标、架构、关键组件和开发约定。它是AI助手理解项目整体框架的主要参考。*

## 📋 项目概述

**项目名称:** MTR Trade Bot  
**项目目标:** 开发一个专业的Telegram机器人，用于在Solana区块链上的Meteora去中心化流动性协议进行交易和管理流动性头寸。

### 项目背景

MTR Trade Bot是一个让用户能够直接从Telegram与Meteora的去中心化流动性市场创建者(DLMM)协议交互的机器人。它简化了发现流动性池、连接Solana钱包、创建和监控交易头寸的过程，全部通过一个直观的聊天界面完成。

### 核心功能

- Telegram Bot界面：用于命令处理和交互式菜单
- 钱包连接与认证：安全连接到Solana钱包
- Meteora协议集成：集成Meteora DLMM SDK进行池操作
- 头寸管理系统：完整的头寸跟踪和监控
- 交易功能：代币交换功能及价格估算

## 🏗️ 技术栈

### 前端

- **框架:** Telegram Bot API
- **UI组件:** 交互式键盘和格式化消息
- **其他关键库:** Telegram交互式菜单

### 后端

- **语言/框架:** TypeScript/Node.js
- **区块链集成:** Solana Web3.js
- **协议集成:** Meteora DLMM SDK
- **数据存储:** 
  - 基于文件的JSON序列化存储
  - PostgreSQL数据库 (通过Prisma ORM)
- **ORM工具:** Prisma
- **API规范:** Telegram Bot API

### 基础设施

- **部署方式:** Node.js服务
- **持久化:** 
  - 文件系统存储
  - Neon PostgreSQL云数据库
- **监控:** 头寸状态变化通知系统

## 🔌 系统架构

### 架构概览

MTR Trade Bot采用模块化架构，具有明确的关注点分离，包括核心Bot模块、专门的处理器模块、业务逻辑服务模块、UI组件和数据模型。

### 主要组件

1. **Bot模块**
   - 用途: 中央命令路由和初始化
   - 交互: 与Telegram API交互，并将命令路由到适当的处理器
   - 关键特性: 命令路由、初始化、错误处理

2. **处理器模块**
   - 用途: 专门处理命令、回调和消息
   - 交互: 与服务模块和UI组件交互
   - 关键特性: 命令处理、回调处理、消息处理

3. **服务模块**
   - 用途: 实现头寸、钱包和查询的业务逻辑
   - 交互: 与Meteora DLMM SDK和Solana Web3.js交互
   - 关键特性: 位置服务、钱包服务、查询服务

4. **UI组件**
   - 用途: 生成菜单和格式化消息
   - 交互: 与处理器模块交互
   - 关键特性: 菜单生成、消息格式化

5. **数据模型**
   - 用途: 头寸存储和用户钱包映射
   - 交互: 与服务模块交互
   - 关键特性: 
     - 存储接口定义
     - 文件存储实现
     - 数据库存储实现
     - 存储工厂

### 数据流

1. 用户通过Telegram发送命令
2. Bot模块接收命令并路由到相应处理器
3. 处理器调用适当的服务模块执行业务逻辑
4. 服务模块与Meteora DLMM SDK和Solana Web3.js交互
5. 服务模块通过存储工厂获取合适的存储实现进行数据操作
6. 处理器使用UI组件生成响应
7. Bot模块将响应发送回用户

### 存储架构

1. **存储接口层**
   - 定义标准存储操作接口
   - 提供不依赖具体实现的数据访问方法

2. **存储实现层**
   - 文件存储实现：基于JSON文件的简单存储
   - Prisma存储实现：基于PostgreSQL的数据库存储

3. **存储工厂**
   - 根据环境配置创建适当的存储实现
   - 提供统一的存储实例获取接口
   - 简化客户端代码，处理实例化逻辑

## 📊 代码组织

### 目录结构

```
/
├── src/                - 源代码目录
│   ├── bot/            - Bot核心模块
│   ├── handlers/       - 命令、回调和消息处理器
│   ├── services/       - 业务逻辑服务
│   ├── ui/             - UI组件
│   ├── models/         - 数据模型和存储实现
│   └── utils/          - 工具函数
├── data/               - 文件数据存储目录
├── config/             - 配置文件
├── prisma/             - Prisma模型和迁移
│   ├── schema.prisma   - 数据库模型定义
│   └── migrations/     - 数据库迁移文件
└── tests/              - 测试文件
```

### 命名约定

- **文件命名:** 使用camelCase
- **组件命名:** 使用PascalCase
- **函数命名:** 使用camelCase
- **变量命名:** 使用camelCase
- **常量命名:** 使用UPPER_SNAKE_CASE
- **接口命名:** 使用I前缀，如IPositionStorage

## 🔄 开发流程

### Git工作流

使用GitHub Flow，主分支(main)始终包含最新的生产就绪代码。功能开发在feature分支进行，完成后通过Pull Request合并回main分支。

### 代码审查标准

- 代码必须遵循TypeScript最佳实践
- 所有新功能必须有相应测试
- 安全功能必须经过特别审查
- 所有PR必须至少有一个批准

### 测试策略

- 单元测试：针对单个函数和组件
- 集成测试：验证模块间交互
- E2E测试：模拟用户与机器人的交互
- 数据库测试：使用测试数据库验证存储操作

## 📝 文档资源

- project-brief.md - 项目简介
- Meteora DLMM文档 - Meteora协议规范
- Telegram Bot API文档 - 机器人交互参考
- Prisma文档 - ORM工具参考

## 项目功能

### 用户界面和交互
- Telegram Bot API集成，用于命令处理和交互菜单
- 丰富的命令集，用于池搜索、头寸管理和钱包连接
- 交互式键盘和格式化消息，提高可用性

### 钱包和认证
- 安全连接到Solana钱包进行交易操作
- 可选的Vault集成，用于加密种子短语存储
- 用户-钱包映射系统，用于管理多个钱包

### Meteora协议集成
- 与Meteora DLMM SDK集成，用于池操作
- 实时池数据查询和显示
- 支持在多个区间创建流动性头寸

### 头寸管理系统
- 带有唯一ID的完整头寸跟踪
- 头寸数据和历史的持久存储
  - 支持文件存储和数据库存储
  - 通过工厂模式自动选择存储实现
- 自动监控活动头寸，具有可配置的时间间隔
- 头寸状态变化的实时通知

### 交易能力
- 代币对交换功能，带价格估算
- 实时汇率信息
- 余额验证和交换确认工作流程

### 数据存储系统
- 灵活的存储层抽象，支持多种后端
- 文件存储实现，适用于开发和测试
- 数据库存储实现，使用Prisma ORM
- 存储工厂模式，简化存储实例创建
- 环境变量配置，动态选择存储类型

---

*最后更新时间: 2024-03-25* 