# 决策日志 (Decision Log)

*此文件记录项目中的关键决策，包括架构选择、技术栈决定和实现策略。它为AI助手提供决策背景和理由。*

## 架构决策

### 2023-07-10: 采用模块化架构
- **背景:** 需要设计一个灵活、可维护的交易机器人系统
- **决策:** 采用模块化架构，将系统分为核心模块、命令处理、钱包管理、池管理和位置管理五个主要模块
- **理由:** 模块化设计使得系统更易于维护、扩展和测试，各组件可以独立开发和更新
- **替代方案:** 单体架构（拒绝：缺乏灵活性）、微服务架构（拒绝：对于此规模项目过于复杂）
- **影响:** 需要明确定义模块间接口，增加初始设计工作，但长期提高开发效率和代码质量

### 2023-07-10: 基于事件的通信机制
- **背景:** 需要一个灵活的方式让不同模块之间通信
- **决策:** 实现一个事件总线，允许模块通过发布-订阅模式进行通信
- **理由:** 事件驱动架构减少了模块间的直接依赖，使系统更松耦合
- **替代方案:** 直接调用（拒绝：造成紧耦合）、REST API（拒绝：对于内部通信过于复杂）
- **影响:** 需要实现事件总线机制，可能增加调试复杂性，但大幅提高系统的灵活性

### 2024-03-22: 采用Jest作为测试框架
- **背景:** 需要为项目建立可靠的自动化测试系统，特别是对仓位监控等关键功能
- **决策:** 采用Jest作为主要测试框架，配合TypeScript类型支持
- **理由:**
  - Jest提供了完整的测试功能，包括模拟(mocking)、断言、覆盖率报告等
  - 与TypeScript良好集成，支持类型安全的测试编写
  - 内置的快照测试和并行执行能力提高测试效率
  - 活跃的社区支持和丰富的文档资源
- **替代方案:**
  - Mocha+Chai（拒绝：需要更多配置和外部依赖）
  - AVA（拒绝：需要更多配置和外部依赖）

### 2024-03-25: 实现存储工厂模式
- **背景:** 随着项目扩展，需要支持不同的存储后端(文件存储和数据库存储)，同时保持代码的灵活性和可测试性
- **决策:** 实现StorageFactory工厂类，用于创建和管理不同的存储实现
- **理由:**
  - 工厂模式提供了一种统一的方式来创建不同的存储实现
  - 将存储类型决策与存储使用分离，提高代码的可维护性
  - 支持在运行时基于环境变量或配置动态选择存储实现
  - 便于将来添加新的存储后端，如Redis、MongoDB等
- **替代方案:**
  - 直接条件判断（拒绝：代码耦合度高，违反开闭原则）
  - 依赖注入容器（部分采用：当前项目规模不需要完整的DI容器）
- **影响:**
  - 简化了存储实现的切换和测试
  - 提高了代码的可扩展性
  - 增加了少量的抽象层次和间接性

## 技术栈决策

### 2023-07-10: 选择TypeScript/Node.js作为开发语言
- **背景:** 需要为交易机器人选择一个适合的开发语言和运行时
- **决策:** 使用TypeScript作为开发语言，Node.js作为运行时环境
- **理由:** TypeScript提供类型安全，减少运行时错误；Node.js生态系统丰富，适合开发网络应用和工具
- **替代方案:** Python（拒绝：虽然有良好的数据分析能力，但类型安全不如TypeScript），Rust（拒绝：学习曲线高，开发速度较慢）
- **影响:** 开发者需要熟悉TypeScript/Node.js，但将提高代码质量和开发效率

### 2023-07-10: 基于文件的数据存储
- **背景:** 需要一个简单的方式存储用户数据和交易记录
- **决策:** 初期使用基于文件的JSON存储
- **理由:** 简单易实现，适合初期开发和测试，无需额外数据库依赖
- **替代方案:** SQL数据库（拒绝：初期过于复杂），NoSQL数据库（保留：未来可能迁移）
- **影响:** 初期快速开发，但随着用户增长需要考虑迁移到更健壮的存储方案

### 2024-03-22: 测试数据隔离策略
- **背景:** 测试环境需要隔离的测试数据，避免影响生产数据或依赖外部服务
- **决策:** 实现专门的测试数据工厂和模拟服务
- **理由:**
  - 测试应当是可重复且确定性的，不受外部服务状态影响
  - 区块链交互测试特别需要模拟响应，避免实际网络调用
  - 数据工厂模式使测试数据创建标准化和可控
- **替代方案:**
  - 使用真实API但测试环境（拒绝：不可靠且速度慢）
  - 内存数据库（部分采用：适用于某些场景但不适合所有测试）
- **影响:**
  - 需要投入时间创建全面的模拟层
  - 提高测试稳定性和速度
  - 测试与实际环境的差异需要谨慎管理

### 2024-03-25: 采用Prisma ORM实现数据库存储
- **背景:** 随着用户量和数据量增长，基于文件的存储系统面临扩展性和并发访问限制
- **决策:** 采用Prisma ORM作为数据库访问层，并选择PostgreSQL作为主要数据库
- **理由:**
  - Prisma提供类型安全的数据库访问，与TypeScript完美集成
  - 支持数据迁移、关系模型和复杂查询，满足应用增长需求
  - 简化数据库操作，自动生成类型定义，减少手动编码错误
  - PostgreSQL提供强大的事务支持、可靠性和扩展性
  - Neon提供云托管的PostgreSQL服务，简化运维
- **替代方案:**
  - TypeORM（拒绝：更复杂的API，不如Prisma直观）
  - Sequelize（拒绝：TypeScript支持不如Prisma完善）
  - MongoDB（拒绝：关系型数据更适合当前应用场景）
- **影响:**
  - 提高数据存储的可靠性、性能和扩展性
  - 支持更复杂的查询和数据关系
  - 增加了项目依赖和复杂性，需要管理数据库连接和迁移
  - 需要同时维护文件存储和数据库存储的兼容性，直到完全迁移

## 实现策略

### 2023-07-10: 命令行界面实现
- **背景:** 需要一个用户界面让用户与交易机器人交互
- **决策:** 实现基于命令行的交互界面，使用命令模式处理用户输入
- **理由:** 命令行界面简单直接，适合交易者使用；命令模式使得指令系统易于扩展
- **替代方案:** 网页界面（拒绝：初期开发成本高），桌面应用（拒绝：跨平台复杂性高）
- **影响:** 用户需要学习命令语法，但操作更高效；未来可以在此基础上开发其他界面

### 2023-07-10: API集成策略
- **背景:** 需要与Meteora DLMM和Solana区块链集成
- **决策:** 使用官方SDK，封装在专门的适配器模块中
- **理由:** 官方SDK提供最可靠的集成，适配器模式使得未来更换或升级SDK更容易
- **替代方案:** 直接API调用（拒绝：实现复杂度高），自定义实现（拒绝：维护成本高）
- **影响:** 依赖第三方SDK的更新和支持，但降低了开发和维护成本

### 2024-03-22: 测试层次策略
- **背景:** 需要一个全面的测试策略，覆盖从单元到端到端的不同测试层次
- **决策:** 实施四层测试架构：单元测试、组件测试、集成测试和端到端测试
- **理由:**
  - 单元测试：验证独立功能单元的正确性
  - 组件测试：验证组件内部交互和状态管理
  - 集成测试：验证多组件协同工作
  - 端到端测试：验证完整流程和用户场景
- **替代方案:**
  - 仅单元测试（拒绝：无法验证组件交互）
  - 仅端到端测试（拒绝：问题定位困难，执行速度慢）
- **影响:**
  - 全面的测试覆盖提高代码质量和可靠性
  - 测试金字塔策略确保测试效率与覆盖度平衡
  - 需要更多初始投入建立测试基础设施

### 2024-03-23: 改进仓位通知机制
- **背景:** 发现当用户通过Telegram创建新仓位时，系统没有立即发送仓位状态通知，只有当价格超出范围时才触发通知
- **决策:** 实现立即检查新仓位的机制，并增强通知日志记录
- **理由:**
  - 用户期望在创建仓位后立即收到确认和状态信息
  - 定时检查任务（默认10秒间隔）可能导致新仓位通知延迟
  - 更详细的日志有助于调试通知问题
- **实施方案:**
  - 添加`checkNewPosition`方法，在仓位创建后立即调用
  - 改进`checkForNotifications`方法，添加更详细的日志
  - 确保仓位创建时正确设置`chatId`
- **影响:**
  - 提高用户体验，增强系统可靠性
  - 简化通知问题的调试流程
  - 建立仓位状态变更的及时反馈机制

### 2024-03-25: 数据存储分层策略
- **背景:** 随着项目发展需要支持多种存储后端，同时保持业务逻辑与存储实现的分离
- **决策:** 实现完整的存储层抽象，包括接口定义、实现类和工厂模式
- **理由:**
  - 定义清晰的存储接口使业务逻辑不依赖具体存储实现
  - 实现多种存储类支持不同场景：文件存储适合开发/测试，数据库存储适合生产
  - 工厂模式提供统一的实例化方式，简化客户端代码
- **实施方案:**
  - 定义`IPositionStorage`和`IUserWalletMapStorage`接口
  - 实现`FilePositionStorage`和`PrismaPositionStorage`
  - 实现`FileUserWalletMapStorage`和`PrismaUserWalletMapStorage`
  - 创建`StorageFactory`用于统一创建存储实例
- **影响:**
  - 提高代码可维护性和可测试性
  - 支持平滑迁移到新存储系统
  - 简化未来扩展新存储类型

## 进度和里程碑决策

### 2023-07-10: 开发优先级
- **背景:** 需要确定系统不同部分的开发顺序
- **决策:** 优先开发核心模块和命令处理系统，然后是钱包集成、池查询和位置管理
- **理由:** 核心模块和命令处理是其他功能的基础；钱包集成是与区块链交互的前提
- **替代方案:** 并行开发所有模块（拒绝：资源有限，增加复杂性）
- **影响:** 初期功能有限，但确保系统基础稳固，逐步增加功能

### 2024-03-25: 数据迁移策略
- **背景:** 需要将现有的基于文件的数据迁移到数据库系统
- **决策:** 实施平行运行策略，逐步迁移数据
- **理由:**
  - 确保系统在迁移过程中保持可用
  - 允许分阶段迁移，降低风险
  - 提供回滚机制，防止迁移问题
- **实施计划:**
  - 保留双存储系统并行运行一段时间
  - 开发数据迁移脚本，将文件数据导入数据库
  - 逐步切换组件使用从文件存储到数据库存储
  - 全部迁移完成后，移除文件存储代码
- **影响:**
  - 短期内增加代码复杂性和维护负担
  - 提供安全的迁移路径
  - 长期提高系统稳定性和扩展性

---

*最后更新时间: 2024-03-25* 