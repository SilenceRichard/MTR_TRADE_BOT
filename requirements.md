# MTR_TRADE_BOT 需求文档

## 项目背景

MTR_TRADE_BOT 是一个专为与 Solana 区块链上的 Meteora 去中心化流动性协议交互而设计的 Telegram 机器人。该机器人使用户能够搜索 Meteora 流动性池，查看这些池的详细信息，连接他们的 Solana 钱包，并直接从 Telegram 界面创建流动性仓位。

## 用户故事

- 作为一个加密货币交易者，我想要搜索并查看 Meteora 流动性池的详细信息，以便做出明智的投资决策。
- 作为一个流动性提供者，我想要创建和管理 Meteora 上的流动性仓位，以便赚取交易费和收益。
- 作为一个 Solana 钱包持有者，我想要安全地连接我的钱包到机器人，以便进行交易操作。
- 作为一个流动性管理者，我想要监控我的仓位状态和价格变动，以便及时调整策略。

## 功能需求

### 核心功能

- 命令处理：支持丰富的 Telegram 命令集，包括搜索池子、查看仓位、管理钱包等。提供内联键盘导航和交互式对话流程。
- 对话管理：跟踪用户查询状态，支持多步骤交互过程，如创建仓位时的参数配置。
- 用户交互：提供友好的界面元素，如内联键盘、格式化消息，以及表情符号增强可读性。
- 通知推送：实时更新用户关于仓位状态和价格变动的信息。

### 机器人特性

1. **池子搜索与发现**
   - 搜索和浏览 Meteora 流动性池
   - 查看详细的池子信息（TVL、APR、交易量、手续费）
   - 获取交易对的实时价格数据

2. **钱包集成**
   - 连接到 Solana 钱包进行交易操作
   - 安全的钱包管理，支持可选的 Vault 集成
   - 查看钱包余额和代币持有量

3. **流动性仓位管理**
   - 在多个 bin 中创建单边流动性仓位
   - 配置交易参数和策略
   - 持久存储和跟踪仓位数据

4. **代币交换功能**
   - 支持代币对之间的交换操作
   - 交换前显示预估的接收数量，基于实时价格数据和交易对信息
   - 显示当前代币之间的实时汇率信息，以辅助用户决策
   - 根据代币类型(tokenX或tokenY)正确计算预估收到的金额，考虑实时汇率
   - 处理余额检查和交换确认流程

5. **仓位监控系统**
   - 使用唯一 ID 完整跟踪仓位
   - 定时监控所有活跃仓位的状态
   - 记录价格和仓位历史数据
   - 通过 `/positions` 命令查看所有仓位的概览，包括价格范围、当前状态和交易详情
   - 通过 `/position <ID>` 命令查看单个仓位的详细信息，包括真实价格范围、当前价格、历史记录等

### 非功能需求

1. **安全性**
   - 安全的钱包管理和私钥处理
   - 交易签名验证
   - 可选的 Vault 集成用于安全存储

2. **性能**
   - 高效的 RPC 调用
   - 支持并发处理多个用户请求
   - 可靠的定时任务执行

3. **可用性**
   - 友好的用户界面
   - 清晰的错误消息
   - 详细的帮助文档和命令说明

## 技术架构

MTR_TRADE_BOT 使用 TypeScript 构建，并利用以下组件：

### 核心组件

- **Telegram Bot API**：用户交互界面
- **Meteora DLMM SDK**：与 Meteora 去中心化流动性市场做市商协议交互
- **Solana Web3.js**：区块链交互和交易管理
- **Vault 集成**：安全的钱包管理，带加密种子短语

### 主要文件

- `src/bot.ts`：主要机器人逻辑和 Telegram 交互处理程序
- `src/queryPools.ts`：搜索和显示池信息的函数
- `src/config.ts`：配置设置和类型定义
- `src/wallet.ts`：钱包管理和认证
- `src/api/DLMM.ts`：Meteora DLMM API 集成
- `src/api/pool.ts`：池查询和数据获取
- `models/PositionStore.ts`：仓位数据存储和管理
- `models/UserWalletMap.ts`：用户钱包映射管理
- `src/utils/`：辅助实用工具，用于格式化、钱包操作和交易构建

### 数据存储

- 基于文件系统的持久化存储
- 支持仓位数据和历史记录管理
- 用户钱包映射存储

### 定时任务系统

- 可配置的监控间隔
- 错误处理和重试机制
- 完善的日志记录

